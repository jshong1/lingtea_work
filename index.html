<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>발주서 → 거래명세서 변환기</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Noto Sans KR', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            padding: 40px;
            max-width: 700px;
            width: 100%;
            text-align: center;
        }
        
        h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .subtitle {
            color: #666;
            font-size: 1.1em;
            margin-bottom: 40px;
        }
        
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 60px 20px;
            margin: 30px 0;
            transition: all 0.3s ease;
            cursor: pointer;
            background: linear-gradient(45deg, #f8f9ff, #f0f2ff);
        }
        
        .upload-area:hover {
            border-color: #764ba2;
            background: linear-gradient(45deg, #f0f2ff, #e8ebff);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.2);
        }
        
        .upload-area.dragover {
            border-color: #764ba2;
            background: linear-gradient(45deg, #e8ebff, #dde1ff);
        }
        
        .upload-icon {
            font-size: 4em;
            color: #667eea;
            margin-bottom: 20px;
        }
        
        .upload-text {
            font-size: 1.2em;
            color: #333;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .upload-hint {
            color: #666;
            font-size: 0.9em;
        }

        /* 기타 특이사항 섹션 */
        .special-options {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            text-align: left;
            border: 2px solid #e9ecef;
        }

        .special-options h3 {
            color: #333;
            font-size: 1.3em;
            margin-bottom: 20px;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .option-group {
            margin-bottom: 20px;
        }

        .option-label {
            font-weight: 600;
            color: #444;
            margin-bottom: 10px;
            display: block;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 5px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #667eea;
            cursor: pointer;
        }

        .checkbox-item label {
            cursor: pointer;
            color: #555;
            font-size: 0.95em;
        }

        .text-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 0.95em;
            transition: border-color 0.3s ease;
        }

        .text-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        #fileInput {
            display: none;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            font-weight: 500;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #b8daff;
        }
        
        .preview {
            margin-top: 30px;
            text-align: left;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .preview h3 {
            margin-bottom: 15px;
            color: #333;
        }
        
        .preview-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .preview-item:last-child {
            border-bottom: none;
        }
        
        .loading {
            display: none;
            margin: 20px 0;
        }
        
        .loading.active {
            display: block;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* PDF 생성을 위한 숨겨진 템플릿 */
        .pdf-template {
            position: absolute;
            left: -9999px;
            top: -9999px;
            width: 210mm;
            background: white;
            font-family: 'Malgun Gothic', '맑은 고딕', 'Noto Sans KR', 'Apple SD Gothic Neo', sans-serif;
            padding: 10mm;
            box-sizing: border-box;
            font-size: 14px;
            line-height: 1.3;
        }

        .pdf-header {
            background: #f0f8ff;
            padding: 2px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
        }

        .pdf-title {
            font-size: 24px;
            font-weight: bold;
            color: #003366;
            margin-bottom: 5px;
        }

        .pdf-info-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
            font-size: 12px;
        }

        .pdf-info-table td {
            border: 1px solid #ddd;
            padding: 8px 6px;
            height: 28px;
            vertical-align: middle;
        }

        .pdf-info-table .label {
            background-color: #f8f9fa;
            font-weight: bold;
            width: 85px;
            color: #333;
            text-align: center;
        }

        .pdf-product-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
            margin-bottom: 15px;
        }

        .pdf-product-table th {
            background-color: #4682b4;
            color: white;
            padding: 8px 6px;
            border: 1px solid #4682b4;
            font-weight: bold;
            text-align: center;
        }

        .pdf-product-table td {
            border: 1px solid #ddd;
            padding: 6px 4px;
            text-align: center;
            vertical-align: middle;
        }

        .pdf-product-table .product-name {
            text-align: left;
            max-width: 200px;
            word-wrap: break-word;
        }

        .pdf-product-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .pdf-total-row {
            background-color: #4682b4 !important;
            color: white !important;
            font-weight: bold;
        }

        .pdf-total-row td {
            background-color: #4682b4 !important;
            color: white !important;
        }

        .pdf-notice {
            background-color: #fff9c4;
            border: 2px solid #ffc107;
            padding: 12px;
            margin-top: 15px;
            border-radius: 5px;
            line-height: 1.5;
        }

        .pdf-notice-text {
            color: #000000;
            font-size: 16px;
            font-weight: normal;
            margin: 0;
        }

        .pdf-notice-item {
            margin: 3px 0;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .checkbox-group {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>📋 거래명세서 변환기</h1>
        <p class="subtitle">발주서 엑셀 파일을 업로드하면 거래명세서 PDF를 생성합니다</p>
        
        <!-- 기타 특이사항 섹션 -->
        <div class="special-options">
            <h3>📝 기타 특이사항</h3>
            
            <div class="option-group">
                <span class="option-label">파렛트 특이사항</span>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="palette1" name="palette" value="일회용 파렛트">
                        <label for="palette1">일회용 파렛트</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="palette2" name="palette" value="아주파렛트">
                        <label for="palette2">아주파렛트</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="palette3" name="palette" value="KPP파렛트">
                        <label for="palette3">KPP파렛트</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="palette4" name="palette" value="상관없음">
                        <label for="palette4">상관없음</label>
                    </div>
                </div>
            </div>

            <div class="option-group">
                <span class="option-label">지게차 하차 가능여부</span>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="forklift1" name="forklift" value="가능">
                        <label for="forklift1">가능</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="forklift2" name="forklift" value="불가능">
                        <label for="forklift2">불가능</label>
                    </div>
                </div>
            </div>

            <div class="option-group">
                <span class="option-label">기사님 직접 하차</span>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="unload1" name="unload" value="요청">
                        <label for="unload1">요청</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="unload2" name="unload" value="상관없음">
                        <label for="unload2">상관없음</label>
                    </div>
                </div>
            </div>

            <div class="option-group">
                <span class="option-label">혼적가능여부</span>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="mixed1" name="mixed" value="가능">
                        <label for="mixed1">가능</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="mixed2" name="mixed" value="불가능">
                        <label for="mixed2">불가능</label>
                    </div>
                </div>
            </div>

            <div class="option-group">
                <span class="option-label">기타 특이사항 (직접 입력)</span>
                <input type="text" id="customNote" class="text-input" placeholder="추가 특이사항이 있으시면 입력해주세요...">
            </div>
        </div>
        
        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">📁</div>
            <div class="upload-text">발주서 엑셀 파일을 선택하세요</div>
            <div class="upload-hint">또는 파일을 여기로 드래그하세요</div>
        </div>
        
        <input type="file" id="fileInput" accept=".xlsx,.xls" />
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div>파일을 처리하는 중...</div>
        </div>
        
        <div id="status"></div>
        <div id="preview"></div>
        
        <button class="btn" id="generatePDF" disabled>📄 거래명세서 PDF 생성</button>
    </div>

    <!-- PDF 생성을 위한 숨겨진 HTML 템플릿 -->
    <div id="pdfTemplate" class="pdf-template"></div>

    <script>
        let excelData = null;
        let parsedData = null;

        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const status = document.getElementById('status');
        const preview = document.getElementById('preview');
        const generateBtn = document.getElementById('generatePDF');
        const loading = document.getElementById('loading');
        const pdfTemplate = document.getElementById('pdfTemplate');

        // 체크박스 그룹별로 단일 선택 처리
        function setupCheckboxGroups() {
            const groups = ['palette', 'forklift', 'unload', 'mixed'];
            
            groups.forEach(groupName => {
                const checkboxes = document.querySelectorAll(`input[name="${groupName}"]`);
                checkboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        if (this.checked) {
                            checkboxes.forEach(cb => {
                                if (cb !== this) cb.checked = false;
                            });
                        }
                    });
                });
            });
        }

        // 특이사항 정보 수집
        function getSpecialOptions() {
            const options = {
                palette: '',
                forklift: '',
                unload: '',
                mixed: '',
                custom: ''
            };

            // 각 그룹별 체크된 값 찾기
            ['palette', 'forklift', 'unload', 'mixed'].forEach(group => {
                const checked = document.querySelector(`input[name="${group}"]:checked`);
                if (checked) {
                    options[group] = checked.value;
                }
            });

            // 직접 입력 텍스트
            options.custom = document.getElementById('customNote').value.trim();

            return options;
        }

        // 특이사항을 텍스트로 변환
        function formatSpecialOptions(options) {
            const lines = [];
            
            if (options.palette) lines.push(`• 팔레트 특이사항: ${options.palette}`);
            if (options.forklift) lines.push(`• 지게차 가능여부: ${options.forklift}`);
            if (options.unload) lines.push(`• 기사님 직접 하차: ${options.unload}`);
            if (options.mixed) lines.push(`• 혼적가능여부: ${options.mixed}`);
            if (options.custom) lines.push(`• 기타 특이사항: ${options.custom}`);
            
            return lines.length > 0 ? lines.join('\n') : '특별한 지시사항 없음';
        }

        // 파일 업로드 이벤트
        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            if (!file.name.match(/\.(xlsx|xls)$/)) {
                showStatus('엑셀 파일만 업로드 가능합니다.', 'error');
                return;
            }

            loading.classList.add('active');
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const workbook = XLSX.read(e.target.result, { type: 'binary' });
                    
                    if (!workbook.SheetNames.includes('발주서양식')) {
                        showStatus('발주서양식 시트를 찾을 수 없습니다.', 'error');
                        loading.classList.remove('active');
                        return;
                    }
                    
                    const worksheet = workbook.Sheets['발주서양식'];
                    excelData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
                    
                    parseExcelData();
                    showPreview();
                    showStatus('파일이 성공적으로 로드되었습니다.', 'success');
                    generateBtn.disabled = false;
                    loading.classList.remove('active');
                    
                } catch (error) {
                    console.error('파일 처리 오류:', error);
                    showStatus('파일 처리 중 오류가 발생했습니다: ' + error.message, 'error');
                    loading.classList.remove('active');
                }
            };
            
            reader.readAsBinaryString(file);
        }

        function getCellValue(row, col) {
            if (!excelData || row < 0 || !excelData[row]) return '';
            return excelData[row][col] || '';
        }

        function convertExcelDate(excelDate) {
            if (!excelDate || isNaN(excelDate)) return excelDate;
            
            // 엑셀 날짜는 1900년 1월 1일부터의 일수
            const excelEpoch = new Date(1900, 0, 1);
            const days = Math.floor(excelDate) - 2; // 엑셀 버그 보정 (1900년을 윤년으로 계산)
            const hours = (excelDate - Math.floor(excelDate)) * 24;
            const minutes = (hours - Math.floor(hours)) * 60;
            
            const date = new Date(excelEpoch);
            date.setDate(date.getDate() + days);
            date.setHours(Math.floor(hours));
            date.setMinutes(Math.floor(minutes));
            
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hour = String(date.getHours()).padStart(2, '0');
            const minute = String(date.getMinutes()).padStart(2, '0');
            
            // 시간이 00:00이면 날짜만, 아니면 날짜+시간
            if (hour === '00' && minute === '00') {
                return `${year}-${month}-${day}`;
            } else {
                return `${year}-${month}-${day} ${hour}:${minute}`;
            }
        }

        function parseExcelData() {
            // 기본 정보 파싱 (0-based 인덱스로 변환: R2 = [1][17])
            const rawCreatedDate = getCellValue(1, 17); // R2
            const rawRequestDate = getCellValue(1, 1);  // B2
            
            parsedData = {
                요청일: convertExcelDate(rawCreatedDate),
                납품일: convertExcelDate(rawRequestDate),
                부서: getCellValue(1, 18),    // S2
                담당: getCellValue(1, 19),    // T2
                거래처코드1: getCellValue(1, 13), // N2
                거래처코드2: getCellValue(1, 14), // O2
                수취인: getCellValue(1, 2),   // C2
                연락처: getCellValue(1, 3),   // D2
                배송처: getCellValue(1, 5),   // F2
                items: []
            };

            // 제품 리스트 파싱 - Y2부터 시작해서 빈 행까지 스캔
            console.log('엑셀 데이터 총 행수:', excelData.length);
            
            for (let i = 1; i < excelData.length; i++) { // Y2부터 시작 (0-based: 행 1부터)
                const product = getCellValue(i, 24);  // Y열 (0-based: 24)
                const quantity = getCellValue(i, 27); // AB열 (0-based: 27) 
                const amount = getCellValue(i, 38);   // AM열 (0-based: 38)
                
                console.log(`행 ${i+1}: 상품=${product}, 수량=${quantity}, 금액=${amount}`);
                
                // 상품명이 있고, 수량이나 금액 중 하나라도 있으면 추가
                if (product && (quantity || amount)) {
                    const numQuantity = parseFloat(quantity) || 0;
                    const numAmount = parseFloat(amount) || 0;
                    const unitPrice = numQuantity > 0 && numAmount > 0 ? Math.round(numAmount / 1.1) / numQuantity : 0;
                    
                    parsedData.items.push({
                        no: parsedData.items.length + 1,
                        product: String(product).trim(),
                        quantity: numQuantity,
                        unitPrice: Math.round(unitPrice),
                        amountExcludingVat: Math.round(numAmount / 1.1),
                        amountIncludingVat: numAmount
                    });
                }
            }
            
            console.log('파싱된 제품 개수:', parsedData.items.length);
            console.log('제품 리스트:', parsedData.items);
        }

        function showPreview() {
            if (!parsedData) return;

            let html = '<h3>📋 거래명세서 미리보기</h3>';
            html += '<div class="preview-item"><strong>요청일:</strong> <span>' + parsedData.요청일 + '</span></div>';
            html += '<div class="preview-item"><strong>납품일:</strong> <span>' + parsedData.납품일 + '</span></div>';
            html += '<div class="preview-item"><strong>부서/담당:</strong> <span>' + parsedData.부서 + ' / ' + parsedData.담당 + '</span></div>';
            html += '<div class="preview-item"><strong>거래처코드:</strong> <span>' + parsedData.거래처코드1 + ' / ' + parsedData.거래처코드2 + '</span></div>';
            html += '<div class="preview-item"><strong>수취인:</strong> <span>' + parsedData.수취인 + '</span></div>';
            html += '<div class="preview-item"><strong>연락처:</strong> <span>' + parsedData.연락처 + '</span></div>';
            html += '<div class="preview-item"><strong>배송처:</strong> <span>' + parsedData.배송처 + '</span></div>';
            html += '<div class="preview-item"><strong>상품 개수:</strong> <span>' + parsedData.items.length + '개</span></div>';
            
            const totalExcVat = parsedData.items.reduce((sum, item) => sum + item.amountExcludingVat, 0);
            const totalIncVat = parsedData.items.reduce((sum, item) => sum + item.amountIncludingVat, 0);
            
            html += '<div class="preview-item"><strong>총 매출액(VAT 제외):</strong> <span>' + totalExcVat.toLocaleString() + '원</span></div>';
            html += '<div class="preview-item"><strong>총 매출액(VAT 포함):</strong> <span>' + totalIncVat.toLocaleString() + '원</span></div>';

            // 특이사항 미리보기 추가
            const specialOptions = getSpecialOptions();
            const specialText = formatSpecialOptions(specialOptions);
            html += '<div class="preview-item"><strong>특이사항:</strong></div>';
            html += '<div style="padding: 10px; background: #fff; border-radius: 5px; margin-top: 5px; white-space: pre-line; font-size: 0.9em;">' + specialText + '</div>';

            preview.innerHTML = html;
        }

        function showStatus(message, type) {
            status.innerHTML = `<div class="status ${type}">${message}</div>`;
            setTimeout(() => {
                status.innerHTML = '';
            }, 5000);
        }

        // PDF 페이지별 템플릿 HTML 생성 (모든 페이지에 특이사항 표시)
        function generatePDFPageHTML(pageItems, pageNumber, totalPages, isLastPage = false) {
            const totalExcVat = pageItems.reduce((sum, item) => sum + item.amountExcludingVat, 0);
            const totalIncVat = pageItems.reduce((sum, item) => sum + item.amountIncludingVat, 0);

            // 특이사항 정보 (모든 페이지에 표시)
            const specialOptions = getSpecialOptions();
            const specialLines = [];
            
            if (specialOptions.palette) specialLines.push(`팔레트 특이사항: ${specialOptions.palette}`);
            if (specialOptions.forklift) specialLines.push(`지게차 가능여부: ${specialOptions.forklift}`);
            if (specialOptions.unload) specialLines.push(`기사님 직접 하차: ${specialOptions.unload}`);
            if (specialOptions.mixed) specialLines.push(`혼적가능여부: ${specialOptions.mixed}`);
            if (specialOptions.custom) specialLines.push(`기타 특이사항: ${specialOptions.custom}`);

            const specialText = specialLines.length > 0 
                ? specialLines.map(line => `<div class="pdf-notice-item">${line}</div>`).join('')
                : '<div class="pdf-notice-item">특별한 지시사항 없음</div>';

            const specialHTML = `
                <div class="pdf-notice">
                    <div class="pdf-notice-text">
                        <strong>작업 지시 사항:</strong><br>
                        ${specialText}
                    </div>
                </div>
            `;

            let html = `
                <div class="pdf-header">
                    <div class="pdf-title">거래명세서 ${totalPages > 1 ? `(${pageNumber}/${totalPages})` : ''}</div>
                </div>

                <table class="pdf-info-table">
                    <tr>
                        <td class="label">요청일</td>
                        <td>${parsedData.요청일 || ''}</td>
                        <td class="label">납품일</td>
                        <td>${parsedData.납품일 || ''}</td>
                    </tr>
                    <tr>
                        <td class="label">부서/담당</td>
                        <td>${(parsedData.부서 || '') + '/' + (parsedData.담당 || '')}</td>
                        <td class="label">거래처코드</td>
                        <td>${(parsedData.거래처코드1 || '') + '/' + (parsedData.거래처코드2 || '')}</td>
                    </tr>
                    <tr>
                        <td class="label">수취인</td>
                        <td>${parsedData.수취인 || ''}</td>
                        <td class="label">연락처</td>
                        <td>${parsedData.연락처 || ''}</td>
                    </tr>
                    <tr>
                        <td class="label">배송처</td>
                        <td colspan="3">${parsedData.배송처 || ''}</td>
                    </tr>
                </table>

                <table class="pdf-product-table">
                    <thead>
                        <tr>
                            <th style="width: 40px;">NO.</th>
                            <th style="width: 250px;">상품</th>
                            <th style="width: 60px;">수량</th>
                            <th style="width: 80px;">단가(VAT-)</th>
                            <th style="width: 100px;">매출액(VAT-)</th>
                            <th style="width: 100px;">매출액(VAT+)</th>
                        </tr>
                    </thead>
                    <tbody>`;

            pageItems.forEach(item => {
                html += `
                    <tr>
                        <td>${item.no}</td>
                        <td class="product-name">${item.product}</td>
                        <td>${item.quantity}</td>
                        <td>${item.unitPrice.toLocaleString()}</td>
                        <td>${item.amountExcludingVat.toLocaleString()}</td>
                        <td>${item.amountIncludingVat.toLocaleString()}</td>
                    </tr>`;
            });

            // 페이지별 소계 (마지막 페이지에는 전체 합계)
            if (isLastPage) {
                const grandTotalExcVat = parsedData.items.reduce((sum, item) => sum + item.amountExcludingVat, 0);
                const grandTotalIncVat = parsedData.items.reduce((sum, item) => sum + item.amountIncludingVat, 0);
                
                html += `
                    <tr class="pdf-total-row">
                        <td colspan="4">전체 합계</td>
                        <td>${grandTotalExcVat.toLocaleString()}</td>
                        <td>${grandTotalIncVat.toLocaleString()}</td>
                    </tr>`;
            } else {
                html += `
                    <tr style="background-color: #e9ecef;">
                        <td colspan="4">페이지 소계</td>
                        <td>${totalExcVat.toLocaleString()}</td>
                        <td>${totalIncVat.toLocaleString()}</td>
                    </tr>`;
            }

            html += `
                    </tbody>
                </table>
                ${specialHTML}
            `;

            return html;
        }

        // PDF 생성 함수 (페이지당 15개 아이템으로 변경)
        async function generatePDF() {
            if (!parsedData) {
                showStatus('데이터를 먼저 로드해주세요.', 'error');
                return;
            }

            loading.classList.add('active');

            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });

                // 페이지당 최대 항목 수를 15개로 변경
                const itemsPerPage = 15; // 한 페이지에 들어갈 수 있는 최대 항목 수
                const totalItems = parsedData.items.length;
                const totalPages = Math.ceil(totalItems / itemsPerPage);

                for (let pageNum = 1; pageNum <= totalPages; pageNum++) {
                    const startIndex = (pageNum - 1) * itemsPerPage;
                    const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
                    const pageItems = parsedData.items.slice(startIndex, endIndex);
                    const isLastPage = pageNum === totalPages;

                    // 페이지별 HTML 생성
                    const pageHTML = generatePDFPageHTML(pageItems, pageNum, totalPages, isLastPage);
                    pdfTemplate.innerHTML = pageHTML;

                    // 템플릿을 화면에 보이도록 임시 위치 변경
                    pdfTemplate.style.left = '0';
                    pdfTemplate.style.top = '0';
                    pdfTemplate.style.position = 'absolute';
                    pdfTemplate.style.zIndex = '-1';
                    pdfTemplate.style.visibility = 'visible';

                    // 잠시 대기 (렌더링 완료를 위해)
                    await new Promise(resolve => setTimeout(resolve, 200));

                    // HTML2Canvas로 이미지 생성
                    const canvas = await html2canvas(pdfTemplate, {
                        scale: 2,
                        useCORS: true,
                        allowTaint: true,
                        backgroundColor: '#ffffff',
                        width: 794,
                        height: 1123,
                        scrollX: 0,
                        scrollY: 0
                    });

                    // 첫 페이지가 아닌 경우 새 페이지 추가
                    if (pageNum > 1) {
                        pdf.addPage();
                    }

                    // 캔버스 이미지를 PDF에 추가
                    const imgData = canvas.toDataURL('image/png', 1.0);
                    const imgWidth = 210; // A4 width in mm
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;

                    // 이미지가 페이지 높이를 초과하지 않도록 조정
                    const maxHeight = 280; // A4 높이에서 여백 제외
                    const finalHeight = Math.min(imgHeight, maxHeight);

                    pdf.addImage(imgData, 'PNG', 0, 10, imgWidth, finalHeight);
                }

                // 템플릿 다시 숨기기
                pdfTemplate.style.left = '-9999px';
                pdfTemplate.style.top = '-9999px';
                pdfTemplate.style.position = 'absolute';
                pdfTemplate.style.zIndex = 'auto';
                pdfTemplate.style.visibility = 'hidden';

                // PDF 다운로드
                const fileName = `거래명세서_${new Date().getFullYear()}${(new Date().getMonth()+1).toString().padStart(2,'0')}${new Date().getDate().toString().padStart(2,'0')}.pdf`;
                pdf.save(fileName);

                showStatus(`PDF가 성공적으로 생성되었습니다! (총 ${totalPages}페이지)`, 'success');

            } catch (error) {
                console.error('PDF 생성 오류:', error);
                showStatus('PDF 생성 중 오류가 발생했습니다: ' + error.message, 'error');
                
                // 오류 시 템플릿 다시 숨기기
                pdfTemplate.style.left = '-9999px';
                pdfTemplate.style.top = '-9999px';
                pdfTemplate.style.position = 'absolute';
                pdfTemplate.style.visibility = 'hidden';
            }

            loading.classList.remove('active');
        }

        // 이벤트 리스너 등록
        generateBtn.addEventListener('click', generatePDF);

        // 초기화 함수 호출
        setupCheckboxGroups();
        
        // 특이사항 변경 시 미리보기 업데이트
        document.querySelectorAll('input[type="checkbox"], #customNote').forEach(element => {
            element.addEventListener('change', () => {
                if (parsedData) {
                    showPreview();
                }
            });
            
            element.addEventListener('input', () => {
                if (parsedData) {
                    showPreview();
                }
            });
        });
    </script>
</body>
</html>
