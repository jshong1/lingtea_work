<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°œì£¼ì„œ â†’ ê±°ë˜ëª…ì„¸ì„œ ë³€í™˜ê¸°</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Noto Sans KR', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            padding: 40px;
            max-width: 700px;
            width: 100%;
            text-align: center;
        }
        
        h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .subtitle {
            color: #666;
            font-size: 1.1em;
            margin-bottom: 40px;
        }
        
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 60px 20px;
            margin: 30px 0;
            transition: all 0.3s ease;
            cursor: pointer;
            background: linear-gradient(45deg, #f8f9ff, #f0f2ff);
        }
        
        .upload-area:hover {
            border-color: #764ba2;
            background: linear-gradient(45deg, #f0f2ff, #e8ebff);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.2);
        }
        
        .upload-area.dragover {
            border-color: #764ba2;
            background: linear-gradient(45deg, #e8ebff, #dde1ff);
        }
        
        .upload-icon {
            font-size: 4em;
            color: #667eea;
            margin-bottom: 20px;
        }
        
        .upload-text {
            font-size: 1.2em;
            color: #333;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .upload-hint {
            color: #666;
            font-size: 0.9em;
        }

        /* ê¸°íƒ€ íŠ¹ì´ì‚¬í•­ ì„¹ì…˜ */
        .special-options {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            text-align: left;
            border: 2px solid #e9ecef;
        }

        .special-options h3 {
            color: #333;
            font-size: 1.3em;
            margin-bottom: 20px;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .option-group {
            margin-bottom: 20px;
        }

        .option-label {
            font-weight: 600;
            color: #444;
            margin-bottom: 10px;
            display: block;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 5px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #667eea;
            cursor: pointer;
        }

        .checkbox-item label {
            cursor: pointer;
            color: #555;
            font-size: 0.95em;
        }

        .text-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 0.95em;
            transition: border-color 0.3s ease;
        }

        .text-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        #fileInput {
            display: none;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            font-weight: 500;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #b8daff;
        }
        
        .preview {
            margin-top: 30px;
            text-align: left;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .preview h3 {
            margin-bottom: 15px;
            color: #333;
        }
        
        .preview-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .preview-item:last-child {
            border-bottom: none;
        }
        
        .loading {
            display: none;
            margin: 20px 0;
        }
        
        .loading.active {
            display: block;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* PDF ìƒì„±ì„ ìœ„í•œ ìˆ¨ê²¨ì§„ í…œí”Œë¦¿ */
        .pdf-template {
            position: absolute;
            left: -9999px;
            top: -9999px;
            width: 210mm;
            background: white;
            font-family: 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', 'Noto Sans KR', 'Apple SD Gothic Neo', sans-serif;
            padding: 10mm;
            box-sizing: border-box;
            font-size: 14px;
            line-height: 1.3;
        }

        .pdf-header {
            background: #f0f8ff;
            padding: 2px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
        }

        .pdf-title {
            font-size: 24px;
            font-weight: bold;
            color: #003366;
            margin-bottom: 5px;
        }

        .pdf-info-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
            font-size: 12px;
        }

        .pdf-info-table td {
            border: 1px solid #ddd;
            padding: 8px 6px;
            height: 28px;
            vertical-align: middle;
        }

        .pdf-info-table .label {
            background-color: #f8f9fa;
            font-weight: bold;
            width: 85px;
            color: #333;
            text-align: center;
        }

        .pdf-product-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
            margin-bottom: 15px;
        }

        .pdf-product-table th {
            background-color: #4682b4;
            color: white;
            padding: 8px 6px;
            border: 1px solid #4682b4;
            font-weight: bold;
            text-align: center;
        }

        .pdf-product-table td {
            border: 1px solid #ddd;
            padding: 6px 4px;
            text-align: center;
            vertical-align: middle;
        }

        .pdf-product-table .product-name {
            text-align: left;
            max-width: 200px;
            word-wrap: break-word;
        }

        .pdf-product-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .pdf-total-row {
            background-color: #4682b4 !important;
            color: white !important;
            font-weight: bold;
        }

        .pdf-total-row td {
            background-color: #4682b4 !important;
            color: white !important;
        }

        .pdf-notice {
            background-color: #fff9c4;
            border: 2px solid #ffc107;
            padding: 12px;
            margin-top: 15px;
            border-radius: 5px;
            line-height: 1.5;
        }

        .pdf-notice-text {
            color: #000000;
            font-size: 16px;
            font-weight: normal;
            margin: 0;
        }

        .pdf-notice-item {
            margin: 3px 0;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .checkbox-group {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“‹ ê±°ë˜ëª…ì„¸ì„œ ë³€í™˜ê¸°</h1>
        <p class="subtitle">ë°œì£¼ì„œ ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ ê±°ë˜ëª…ì„¸ì„œ PDFë¥¼ ìƒì„±í•©ë‹ˆë‹¤</p>
        
        <!-- ê¸°íƒ€ íŠ¹ì´ì‚¬í•­ ì„¹ì…˜ -->
        <div class="special-options">
            <h3>ğŸ“ ê¸°íƒ€ íŠ¹ì´ì‚¬í•­</h3>
            
            <div class="option-group">
                <span class="option-label">íŒŒë ›íŠ¸ íŠ¹ì´ì‚¬í•­</span>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="palette1" name="palette" value="ì¼íšŒìš© íŒŒë ›íŠ¸">
                        <label for="palette1">ì¼íšŒìš© íŒŒë ›íŠ¸</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="palette2" name="palette" value="ì•„ì£¼íŒŒë ›íŠ¸">
                        <label for="palette2">ì•„ì£¼íŒŒë ›íŠ¸</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="palette3" name="palette" value="KPPíŒŒë ›íŠ¸">
                        <label for="palette3">KPPíŒŒë ›íŠ¸</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="palette4" name="palette" value="ìƒê´€ì—†ìŒ">
                        <label for="palette4">ìƒê´€ì—†ìŒ</label>
                    </div>
                </div>
            </div>

            <div class="option-group">
                <span class="option-label">ì§€ê²Œì°¨ í•˜ì°¨ ê°€ëŠ¥ì—¬ë¶€</span>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="forklift1" name="forklift" value="ê°€ëŠ¥">
                        <label for="forklift1">ê°€ëŠ¥</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="forklift2" name="forklift" value="ë¶ˆê°€ëŠ¥">
                        <label for="forklift2">ë¶ˆê°€ëŠ¥</label>
                    </div>
                </div>
            </div>

            <div class="option-group">
                <span class="option-label">ê¸°ì‚¬ë‹˜ ì§ì ‘ í•˜ì°¨</span>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="unload1" name="unload" value="ìš”ì²­">
                        <label for="unload1">ìš”ì²­</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="unload2" name="unload" value="ìƒê´€ì—†ìŒ">
                        <label for="unload2">ìƒê´€ì—†ìŒ</label>
                    </div>
                </div>
            </div>

            <div class="option-group">
                <span class="option-label">í˜¼ì ê°€ëŠ¥ì—¬ë¶€</span>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="mixed1" name="mixed" value="ê°€ëŠ¥">
                        <label for="mixed1">ê°€ëŠ¥</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="mixed2" name="mixed" value="ë¶ˆê°€ëŠ¥">
                        <label for="mixed2">ë¶ˆê°€ëŠ¥</label>
                    </div>
                </div>
            </div>

            <div class="option-group">
                <span class="option-label">ê¸°íƒ€ íŠ¹ì´ì‚¬í•­ (ì§ì ‘ ì…ë ¥)</span>
                <input type="text" id="customNote" class="text-input" placeholder="ì¶”ê°€ íŠ¹ì´ì‚¬í•­ì´ ìˆìœ¼ì‹œë©´ ì…ë ¥í•´ì£¼ì„¸ìš”...">
            </div>
        </div>
        
        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">ğŸ“</div>
            <div class="upload-text">ë°œì£¼ì„œ ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”</div>
            <div class="upload-hint">ë˜ëŠ” íŒŒì¼ì„ ì—¬ê¸°ë¡œ ë“œë˜ê·¸í•˜ì„¸ìš”</div>
        </div>
        
        <input type="file" id="fileInput" accept=".xlsx,.xls" />
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div>íŒŒì¼ì„ ì²˜ë¦¬í•˜ëŠ” ì¤‘...</div>
        </div>
        
        <div id="status"></div>
        <div id="preview"></div>
        
        <button class="btn" id="generatePDF" disabled>ğŸ“„ ê±°ë˜ëª…ì„¸ì„œ PDF ìƒì„±</button>
    </div>

    <!-- PDF ìƒì„±ì„ ìœ„í•œ ìˆ¨ê²¨ì§„ HTML í…œí”Œë¦¿ -->
    <div id="pdfTemplate" class="pdf-template"></div>

    <script>
        let excelData = null;
        let parsedData = null;

        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const status = document.getElementById('status');
        const preview = document.getElementById('preview');
        const generateBtn = document.getElementById('generatePDF');
        const loading = document.getElementById('loading');
        const pdfTemplate = document.getElementById('pdfTemplate');

        // ì²´í¬ë°•ìŠ¤ ê·¸ë£¹ë³„ë¡œ ë‹¨ì¼ ì„ íƒ ì²˜ë¦¬
        function setupCheckboxGroups() {
            const groups = ['palette', 'forklift', 'unload', 'mixed'];
            
            groups.forEach(groupName => {
                const checkboxes = document.querySelectorAll(`input[name="${groupName}"]`);
                checkboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        if (this.checked) {
                            checkboxes.forEach(cb => {
                                if (cb !== this) cb.checked = false;
                            });
                        }
                    });
                });
            });
        }

        // íŠ¹ì´ì‚¬í•­ ì •ë³´ ìˆ˜ì§‘
        function getSpecialOptions() {
            const options = {
                palette: '',
                forklift: '',
                unload: '',
                mixed: '',
                custom: ''
            };

            // ê° ê·¸ë£¹ë³„ ì²´í¬ëœ ê°’ ì°¾ê¸°
            ['palette', 'forklift', 'unload', 'mixed'].forEach(group => {
                const checked = document.querySelector(`input[name="${group}"]:checked`);
                if (checked) {
                    options[group] = checked.value;
                }
            });

            // ì§ì ‘ ì…ë ¥ í…ìŠ¤íŠ¸
            options.custom = document.getElementById('customNote').value.trim();

            return options;
        }

        // íŠ¹ì´ì‚¬í•­ì„ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜
        function formatSpecialOptions(options) {
            const lines = [];
            
            if (options.palette) lines.push(`â€¢ íŒ”ë ˆíŠ¸ íŠ¹ì´ì‚¬í•­: ${options.palette}`);
            if (options.forklift) lines.push(`â€¢ ì§€ê²Œì°¨ ê°€ëŠ¥ì—¬ë¶€: ${options.forklift}`);
            if (options.unload) lines.push(`â€¢ ê¸°ì‚¬ë‹˜ ì§ì ‘ í•˜ì°¨: ${options.unload}`);
            if (options.mixed) lines.push(`â€¢ í˜¼ì ê°€ëŠ¥ì—¬ë¶€: ${options.mixed}`);
            if (options.custom) lines.push(`â€¢ ê¸°íƒ€ íŠ¹ì´ì‚¬í•­: ${options.custom}`);
            
            return lines.length > 0 ? lines.join('\n') : 'íŠ¹ë³„í•œ ì§€ì‹œì‚¬í•­ ì—†ìŒ';
        }

        // íŒŒì¼ ì—…ë¡œë“œ ì´ë²¤íŠ¸
        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            if (!file.name.match(/\.(xlsx|xls)$/)) {
                showStatus('ì—‘ì…€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.', 'error');
                return;
            }

            loading.classList.add('active');
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const workbook = XLSX.read(e.target.result, { type: 'binary' });
                    
                    if (!workbook.SheetNames.includes('ë°œì£¼ì„œì–‘ì‹')) {
                        showStatus('ë°œì£¼ì„œì–‘ì‹ ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                        loading.classList.remove('active');
                        return;
                    }
                    
                    const worksheet = workbook.Sheets['ë°œì£¼ì„œì–‘ì‹'];
                    excelData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
                    
                    parseExcelData();
                    showPreview();
                    showStatus('íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    generateBtn.disabled = false;
                    loading.classList.remove('active');
                    
                } catch (error) {
                    console.error('íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                    showStatus('íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
                    loading.classList.remove('active');
                }
            };
            
            reader.readAsBinaryString(file);
        }

        function getCellValue(row, col) {
            if (!excelData || row < 0 || !excelData[row]) return '';
            return excelData[row][col] || '';
        }

        function convertExcelDate(excelDate) {
            if (!excelDate || isNaN(excelDate)) return excelDate;
            
            // ì—‘ì…€ ë‚ ì§œëŠ” 1900ë…„ 1ì›” 1ì¼ë¶€í„°ì˜ ì¼ìˆ˜
            const excelEpoch = new Date(1900, 0, 1);
            const days = Math.floor(excelDate) - 2; // ì—‘ì…€ ë²„ê·¸ ë³´ì • (1900ë…„ì„ ìœ¤ë…„ìœ¼ë¡œ ê³„ì‚°)
            const hours = (excelDate - Math.floor(excelDate)) * 24;
            const minutes = (hours - Math.floor(hours)) * 60;
            
            const date = new Date(excelEpoch);
            date.setDate(date.getDate() + days);
            date.setHours(Math.floor(hours));
            date.setMinutes(Math.floor(minutes));
            
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hour = String(date.getHours()).padStart(2, '0');
            const minute = String(date.getMinutes()).padStart(2, '0');
            
            // ì‹œê°„ì´ 00:00ì´ë©´ ë‚ ì§œë§Œ, ì•„ë‹ˆë©´ ë‚ ì§œ+ì‹œê°„
            if (hour === '00' && minute === '00') {
                return `${year}-${month}-${day}`;
            } else {
                return `${year}-${month}-${day} ${hour}:${minute}`;
            }
        }

        function parseExcelData() {
            // ê¸°ë³¸ ì •ë³´ íŒŒì‹± (0-based ì¸ë±ìŠ¤ë¡œ ë³€í™˜: R2 = [1][17])
            const rawCreatedDate = getCellValue(1, 17); // R2
            const rawRequestDate = getCellValue(1, 1);  // B2
            
            parsedData = {
                ìš”ì²­ì¼: convertExcelDate(rawCreatedDate),
                ë‚©í’ˆì¼: convertExcelDate(rawRequestDate),
                ë¶€ì„œ: getCellValue(1, 18),    // S2
                ë‹´ë‹¹: getCellValue(1, 19),    // T2
                ê±°ë˜ì²˜ì½”ë“œ1: getCellValue(1, 13), // N2
                ê±°ë˜ì²˜ì½”ë“œ2: getCellValue(1, 14), // O2
                ìˆ˜ì·¨ì¸: getCellValue(1, 2),   // C2
                ì—°ë½ì²˜: getCellValue(1, 3),   // D2
                ë°°ì†¡ì²˜: getCellValue(1, 5),   // F2
                items: []
            };

            // ì œí’ˆ ë¦¬ìŠ¤íŠ¸ íŒŒì‹± - Y2ë¶€í„° ì‹œì‘í•´ì„œ ë¹ˆ í–‰ê¹Œì§€ ìŠ¤ìº”
            console.log('ì—‘ì…€ ë°ì´í„° ì´ í–‰ìˆ˜:', excelData.length);
            
            for (let i = 1; i < excelData.length; i++) { // Y2ë¶€í„° ì‹œì‘ (0-based: í–‰ 1ë¶€í„°)
                const product = getCellValue(i, 24);  // Yì—´ (0-based: 24)
                const quantity = getCellValue(i, 27); // ABì—´ (0-based: 27) 
                const amount = getCellValue(i, 38);   // AMì—´ (0-based: 38)
                
                console.log(`í–‰ ${i+1}: ìƒí’ˆ=${product}, ìˆ˜ëŸ‰=${quantity}, ê¸ˆì•¡=${amount}`);
                
                // ìƒí’ˆëª…ì´ ìˆê³ , ìˆ˜ëŸ‰ì´ë‚˜ ê¸ˆì•¡ ì¤‘ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ ì¶”ê°€
                if (product && (quantity || amount)) {
                    const numQuantity = parseFloat(quantity) || 0;
                    const numAmount = parseFloat(amount) || 0;
                    const unitPrice = numQuantity > 0 && numAmount > 0 ? Math.round(numAmount / 1.1) / numQuantity : 0;
                    
                    parsedData.items.push({
                        no: parsedData.items.length + 1,
                        product: String(product).trim(),
                        quantity: numQuantity,
                        unitPrice: Math.round(unitPrice),
                        amountExcludingVat: Math.round(numAmount / 1.1),
                        amountIncludingVat: numAmount
                    });
                }
            }
            
            console.log('íŒŒì‹±ëœ ì œí’ˆ ê°œìˆ˜:', parsedData.items.length);
            console.log('ì œí’ˆ ë¦¬ìŠ¤íŠ¸:', parsedData.items);
        }

        function showPreview() {
            if (!parsedData) return;

            let html = '<h3>ğŸ“‹ ê±°ë˜ëª…ì„¸ì„œ ë¯¸ë¦¬ë³´ê¸°</h3>';
            html += '<div class="preview-item"><strong>ìš”ì²­ì¼:</strong> <span>' + parsedData.ìš”ì²­ì¼ + '</span></div>';
            html += '<div class="preview-item"><strong>ë‚©í’ˆì¼:</strong> <span>' + parsedData.ë‚©í’ˆì¼ + '</span></div>';
            html += '<div class="preview-item"><strong>ë¶€ì„œ/ë‹´ë‹¹:</strong> <span>' + parsedData.ë¶€ì„œ + ' / ' + parsedData.ë‹´ë‹¹ + '</span></div>';
            html += '<div class="preview-item"><strong>ê±°ë˜ì²˜ì½”ë“œ:</strong> <span>' + parsedData.ê±°ë˜ì²˜ì½”ë“œ1 + ' / ' + parsedData.ê±°ë˜ì²˜ì½”ë“œ2 + '</span></div>';
            html += '<div class="preview-item"><strong>ìˆ˜ì·¨ì¸:</strong> <span>' + parsedData.ìˆ˜ì·¨ì¸ + '</span></div>';
            html += '<div class="preview-item"><strong>ì—°ë½ì²˜:</strong> <span>' + parsedData.ì—°ë½ì²˜ + '</span></div>';
            html += '<div class="preview-item"><strong>ë°°ì†¡ì²˜:</strong> <span>' + parsedData.ë°°ì†¡ì²˜ + '</span></div>';
            html += '<div class="preview-item"><strong>ìƒí’ˆ ê°œìˆ˜:</strong> <span>' + parsedData.items.length + 'ê°œ</span></div>';
            
            const totalExcVat = parsedData.items.reduce((sum, item) => sum + item.amountExcludingVat, 0);
            const totalIncVat = parsedData.items.reduce((sum, item) => sum + item.amountIncludingVat, 0);
            
            html += '<div class="preview-item"><strong>ì´ ë§¤ì¶œì•¡(VAT ì œì™¸):</strong> <span>' + totalExcVat.toLocaleString() + 'ì›</span></div>';
            html += '<div class="preview-item"><strong>ì´ ë§¤ì¶œì•¡(VAT í¬í•¨):</strong> <span>' + totalIncVat.toLocaleString() + 'ì›</span></div>';

            // íŠ¹ì´ì‚¬í•­ ë¯¸ë¦¬ë³´ê¸° ì¶”ê°€
            const specialOptions = getSpecialOptions();
            const specialText = formatSpecialOptions(specialOptions);
            html += '<div class="preview-item"><strong>íŠ¹ì´ì‚¬í•­:</strong></div>';
            html += '<div style="padding: 10px; background: #fff; border-radius: 5px; margin-top: 5px; white-space: pre-line; font-size: 0.9em;">' + specialText + '</div>';

            preview.innerHTML = html;
        }

        function showStatus(message, type) {
            status.innerHTML = `<div class="status ${type}">${message}</div>`;
            setTimeout(() => {
                status.innerHTML = '';
            }, 5000);
        }

        // PDF í˜ì´ì§€ë³„ í…œí”Œë¦¿ HTML ìƒì„± (ëª¨ë“  í˜ì´ì§€ì— íŠ¹ì´ì‚¬í•­ í‘œì‹œ)
        function generatePDFPageHTML(pageItems, pageNumber, totalPages, isLastPage = false) {
            const totalExcVat = pageItems.reduce((sum, item) => sum + item.amountExcludingVat, 0);
            const totalIncVat = pageItems.reduce((sum, item) => sum + item.amountIncludingVat, 0);

            // íŠ¹ì´ì‚¬í•­ ì •ë³´ (ëª¨ë“  í˜ì´ì§€ì— í‘œì‹œ)
            const specialOptions = getSpecialOptions();
            const specialLines = [];
            
            if (specialOptions.palette) specialLines.push(`íŒ”ë ˆíŠ¸ íŠ¹ì´ì‚¬í•­: ${specialOptions.palette}`);
            if (specialOptions.forklift) specialLines.push(`ì§€ê²Œì°¨ ê°€ëŠ¥ì—¬ë¶€: ${specialOptions.forklift}`);
            if (specialOptions.unload) specialLines.push(`ê¸°ì‚¬ë‹˜ ì§ì ‘ í•˜ì°¨: ${specialOptions.unload}`);
            if (specialOptions.mixed) specialLines.push(`í˜¼ì ê°€ëŠ¥ì—¬ë¶€: ${specialOptions.mixed}`);
            if (specialOptions.custom) specialLines.push(`ê¸°íƒ€ íŠ¹ì´ì‚¬í•­: ${specialOptions.custom}`);

            const specialText = specialLines.length > 0 
                ? specialLines.map(line => `<div class="pdf-notice-item">${line}</div>`).join('')
                : '<div class="pdf-notice-item">íŠ¹ë³„í•œ ì§€ì‹œì‚¬í•­ ì—†ìŒ</div>';

            const specialHTML = `
                <div class="pdf-notice">
                    <div class="pdf-notice-text">
                        <strong>ì‘ì—… ì§€ì‹œ ì‚¬í•­:</strong><br>
                        ${specialText}
                    </div>
                </div>
            `;

            let html = `
                <div class="pdf-header">
                    <div class="pdf-title">ê±°ë˜ëª…ì„¸ì„œ ${totalPages > 1 ? `(${pageNumber}/${totalPages})` : ''}</div>
                </div>

                <table class="pdf-info-table">
                    <tr>
                        <td class="label">ìš”ì²­ì¼</td>
                        <td>${parsedData.ìš”ì²­ì¼ || ''}</td>
                        <td class="label">ë‚©í’ˆì¼</td>
                        <td>${parsedData.ë‚©í’ˆì¼ || ''}</td>
                    </tr>
                    <tr>
                        <td class="label">ë¶€ì„œ/ë‹´ë‹¹</td>
                        <td>${(parsedData.ë¶€ì„œ || '') + '/' + (parsedData.ë‹´ë‹¹ || '')}</td>
                        <td class="label">ê±°ë˜ì²˜ì½”ë“œ</td>
                        <td>${(parsedData.ê±°ë˜ì²˜ì½”ë“œ1 || '') + '/' + (parsedData.ê±°ë˜ì²˜ì½”ë“œ2 || '')}</td>
                    </tr>
                    <tr>
                        <td class="label">ìˆ˜ì·¨ì¸</td>
                        <td>${parsedData.ìˆ˜ì·¨ì¸ || ''}</td>
                        <td class="label">ì—°ë½ì²˜</td>
                        <td>${parsedData.ì—°ë½ì²˜ || ''}</td>
                    </tr>
                    <tr>
                        <td class="label">ë°°ì†¡ì²˜</td>
                        <td colspan="3">${parsedData.ë°°ì†¡ì²˜ || ''}</td>
                    </tr>
                </table>

                <table class="pdf-product-table">
                    <thead>
                        <tr>
                            <th style="width: 40px;">NO.</th>
                            <th style="width: 250px;">ìƒí’ˆ</th>
                            <th style="width: 60px;">ìˆ˜ëŸ‰</th>
                            <th style="width: 80px;">ë‹¨ê°€(VAT-)</th>
                            <th style="width: 100px;">ë§¤ì¶œì•¡(VAT-)</th>
                            <th style="width: 100px;">ë§¤ì¶œì•¡(VAT+)</th>
                        </tr>
                    </thead>
                    <tbody>`;

            pageItems.forEach(item => {
                html += `
                    <tr>
                        <td>${item.no}</td>
                        <td class="product-name">${item.product}</td>
                        <td>${item.quantity}</td>
                        <td>${item.unitPrice.toLocaleString()}</td>
                        <td>${item.amountExcludingVat.toLocaleString()}</td>
                        <td>${item.amountIncludingVat.toLocaleString()}</td>
                    </tr>`;
            });

            // í˜ì´ì§€ë³„ ì†Œê³„ (ë§ˆì§€ë§‰ í˜ì´ì§€ì—ëŠ” ì „ì²´ í•©ê³„)
            if (isLastPage) {
                const grandTotalExcVat = parsedData.items.reduce((sum, item) => sum + item.amountExcludingVat, 0);
                const grandTotalIncVat = parsedData.items.reduce((sum, item) => sum + item.amountIncludingVat, 0);
                
                html += `
                    <tr class="pdf-total-row">
                        <td colspan="4">ì „ì²´ í•©ê³„</td>
                        <td>${grandTotalExcVat.toLocaleString()}</td>
                        <td>${grandTotalIncVat.toLocaleString()}</td>
                    </tr>`;
            } else {
                html += `
                    <tr style="background-color: #e9ecef;">
                        <td colspan="4">í˜ì´ì§€ ì†Œê³„</td>
                        <td>${totalExcVat.toLocaleString()}</td>
                        <td>${totalIncVat.toLocaleString()}</td>
                    </tr>`;
            }

            html += `
                    </tbody>
                </table>
                ${specialHTML}
            `;

            return html;
        }

        // PDF ìƒì„± í•¨ìˆ˜ (í˜ì´ì§€ë‹¹ 15ê°œ ì•„ì´í…œìœ¼ë¡œ ë³€ê²½)
        async function generatePDF() {
            if (!parsedData) {
                showStatus('ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            loading.classList.add('active');

            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });

                // í˜ì´ì§€ë‹¹ ìµœëŒ€ í•­ëª© ìˆ˜ë¥¼ 15ê°œë¡œ ë³€ê²½
                const itemsPerPage = 15; // í•œ í˜ì´ì§€ì— ë“¤ì–´ê°ˆ ìˆ˜ ìˆëŠ” ìµœëŒ€ í•­ëª© ìˆ˜
                const totalItems = parsedData.items.length;
                const totalPages = Math.ceil(totalItems / itemsPerPage);

                for (let pageNum = 1; pageNum <= totalPages; pageNum++) {
                    const startIndex = (pageNum - 1) * itemsPerPage;
                    const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
                    const pageItems = parsedData.items.slice(startIndex, endIndex);
                    const isLastPage = pageNum === totalPages;

                    // í˜ì´ì§€ë³„ HTML ìƒì„±
                    const pageHTML = generatePDFPageHTML(pageItems, pageNum, totalPages, isLastPage);
                    pdfTemplate.innerHTML = pageHTML;

                    // í…œí”Œë¦¿ì„ í™”ë©´ì— ë³´ì´ë„ë¡ ì„ì‹œ ìœ„ì¹˜ ë³€ê²½
                    pdfTemplate.style.left = '0';
                    pdfTemplate.style.top = '0';
                    pdfTemplate.style.position = 'absolute';
                    pdfTemplate.style.zIndex = '-1';
                    pdfTemplate.style.visibility = 'visible';

                    // ì ì‹œ ëŒ€ê¸° (ë Œë”ë§ ì™„ë£Œë¥¼ ìœ„í•´)
                    await new Promise(resolve => setTimeout(resolve, 200));

                    // HTML2Canvasë¡œ ì´ë¯¸ì§€ ìƒì„±
                    const canvas = await html2canvas(pdfTemplate, {
                        scale: 2,
                        useCORS: true,
                        allowTaint: true,
                        backgroundColor: '#ffffff',
                        width: 794,
                        height: 1123,
                        scrollX: 0,
                        scrollY: 0
                    });

                    // ì²« í˜ì´ì§€ê°€ ì•„ë‹Œ ê²½ìš° ìƒˆ í˜ì´ì§€ ì¶”ê°€
                    if (pageNum > 1) {
                        pdf.addPage();
                    }

                    // ìº”ë²„ìŠ¤ ì´ë¯¸ì§€ë¥¼ PDFì— ì¶”ê°€
                    const imgData = canvas.toDataURL('image/png', 1.0);
                    const imgWidth = 210; // A4 width in mm
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;

                    // ì´ë¯¸ì§€ê°€ í˜ì´ì§€ ë†’ì´ë¥¼ ì´ˆê³¼í•˜ì§€ ì•Šë„ë¡ ì¡°ì •
                    const maxHeight = 280; // A4 ë†’ì´ì—ì„œ ì—¬ë°± ì œì™¸
                    const finalHeight = Math.min(imgHeight, maxHeight);

                    pdf.addImage(imgData, 'PNG', 0, 10, imgWidth, finalHeight);
                }

                // í…œí”Œë¦¿ ë‹¤ì‹œ ìˆ¨ê¸°ê¸°
                pdfTemplate.style.left = '-9999px';
                pdfTemplate.style.top = '-9999px';
                pdfTemplate.style.position = 'absolute';
                pdfTemplate.style.zIndex = 'auto';
                pdfTemplate.style.visibility = 'hidden';

                // PDF ë‹¤ìš´ë¡œë“œ
                const fileName = `ê±°ë˜ëª…ì„¸ì„œ_${new Date().getFullYear()}${(new Date().getMonth()+1).toString().padStart(2,'0')}${new Date().getDate().toString().padStart(2,'0')}.pdf`;
                pdf.save(fileName);

                showStatus(`PDFê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤! (ì´ ${totalPages}í˜ì´ì§€)`, 'success');

            } catch (error) {
                console.error('PDF ìƒì„± ì˜¤ë¥˜:', error);
                showStatus('PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
                
                // ì˜¤ë¥˜ ì‹œ í…œí”Œë¦¿ ë‹¤ì‹œ ìˆ¨ê¸°ê¸°
                pdfTemplate.style.left = '-9999px';
                pdfTemplate.style.top = '-9999px';
                pdfTemplate.style.position = 'absolute';
                pdfTemplate.style.visibility = 'hidden';
            }

            loading.classList.remove('active');
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        generateBtn.addEventListener('click', generatePDF);

        // ì´ˆê¸°í™” í•¨ìˆ˜ í˜¸ì¶œ
        setupCheckboxGroups();
        
        // íŠ¹ì´ì‚¬í•­ ë³€ê²½ ì‹œ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
        document.querySelectorAll('input[type="checkbox"], #customNote').forEach(element => {
            element.addEventListener('change', () => {
                if (parsedData) {
                    showPreview();
                }
            });
            
            element.addEventListener('input', () => {
                if (parsedData) {
                    showPreview();
                }
            });
        });
    </script>
</body>
</html>
